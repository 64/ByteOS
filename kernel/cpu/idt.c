#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/util.h>
#include <descriptors.h>
#include <interrupt.h>

static struct {
	struct idt_entry entries[256];
	struct idt_pointer pointer;
} idt COMPILER_ATTR_USED;

void idt_set_entry(uint8_t index, idt_gate base, uint16_t selector, uint8_t flags) {
	idt.entries[index].base_low = ((uintptr_t)base & 0xFFFF);
	idt.entries[index].base_high = ((uintptr_t)base >> 16) & 0xFFFF;
	idt.entries[index].selector = selector;
	idt.entries[index].always_zero = 0;
	idt.entries[index].flags = flags | 0x60;
}

#define INSTALL_ISR(index) { \
		extern void  _isr##index(); \
		idt_set_entry((index), (_isr##index), 0x08, 0x8E); \
	}

void idt_install(void) {
	struct idt_pointer *idt_p = &idt.pointer;
	idt_p->size = (uint16_t)(sizeof(idt.entries) - 1);
	idt_p->base = (uintptr_t)(idt.entries);
	memset((void*)idt.entries, 0, sizeof(idt.entries));

	INSTALL_ISR(0);
	INSTALL_ISR(1);
	INSTALL_ISR(2);
	INSTALL_ISR(3);
	INSTALL_ISR(4);
	INSTALL_ISR(5);
	INSTALL_ISR(6);
	INSTALL_ISR(7);
	INSTALL_ISR(8);
	INSTALL_ISR(9);
	INSTALL_ISR(10);
	INSTALL_ISR(11);
	INSTALL_ISR(12);
	INSTALL_ISR(13);
	INSTALL_ISR(14);
	INSTALL_ISR(15);
	INSTALL_ISR(16);
	INSTALL_ISR(17);
	INSTALL_ISR(18);
	INSTALL_ISR(19);
	INSTALL_ISR(20);
	INSTALL_ISR(21);
	INSTALL_ISR(22);
	INSTALL_ISR(23);
	INSTALL_ISR(24);
	INSTALL_ISR(25);
	INSTALL_ISR(26);
	INSTALL_ISR(27);
	INSTALL_ISR(28);
	INSTALL_ISR(29);
	INSTALL_ISR(30);
	INSTALL_ISR(31);

	INSTALL_ISR(48);
	INSTALL_ISR(49);
	INSTALL_ISR(50);
	INSTALL_ISR(51);
	INSTALL_ISR(52);
	INSTALL_ISR(53);
	INSTALL_ISR(54);
	INSTALL_ISR(55);
	INSTALL_ISR(56);
	INSTALL_ISR(57);
	INSTALL_ISR(58);
	INSTALL_ISR(59);
	INSTALL_ISR(60);
	INSTALL_ISR(61);
	INSTALL_ISR(62);
	INSTALL_ISR(63);
	INSTALL_ISR(64);
	INSTALL_ISR(65);
	INSTALL_ISR(66);
	INSTALL_ISR(67);
	INSTALL_ISR(68);
	INSTALL_ISR(69);
	INSTALL_ISR(70);
	INSTALL_ISR(71);
	INSTALL_ISR(72);
	INSTALL_ISR(73);
	INSTALL_ISR(74);
	INSTALL_ISR(75);
	INSTALL_ISR(76);
	INSTALL_ISR(77);
	INSTALL_ISR(78);
	INSTALL_ISR(79);
	INSTALL_ISR(80);
	INSTALL_ISR(81);
	INSTALL_ISR(82);
	INSTALL_ISR(83);
	INSTALL_ISR(84);
	INSTALL_ISR(85);
	INSTALL_ISR(86);
	INSTALL_ISR(87);
	INSTALL_ISR(88);
	INSTALL_ISR(89);
	INSTALL_ISR(90);
	INSTALL_ISR(91);
	INSTALL_ISR(92);
	INSTALL_ISR(93);
	INSTALL_ISR(94);
	INSTALL_ISR(95);
	INSTALL_ISR(96);
	INSTALL_ISR(97);
	INSTALL_ISR(98);
	INSTALL_ISR(99);
	INSTALL_ISR(100);
	INSTALL_ISR(101);
	INSTALL_ISR(102);
	INSTALL_ISR(103);
	INSTALL_ISR(104);
	INSTALL_ISR(105);
	INSTALL_ISR(106);
	INSTALL_ISR(107);
	INSTALL_ISR(108);
	INSTALL_ISR(109);
	INSTALL_ISR(110);
	INSTALL_ISR(111);
	INSTALL_ISR(112);
	INSTALL_ISR(113);
	INSTALL_ISR(114);
	INSTALL_ISR(115);
	INSTALL_ISR(116);
	INSTALL_ISR(117);
	INSTALL_ISR(118);
	INSTALL_ISR(119);
	INSTALL_ISR(120);
	INSTALL_ISR(121);
	INSTALL_ISR(122);
	INSTALL_ISR(123);
	INSTALL_ISR(124);
	INSTALL_ISR(125);
	INSTALL_ISR(126);
	INSTALL_ISR(127);
	INSTALL_ISR(128);
	INSTALL_ISR(129);
	INSTALL_ISR(130);
	INSTALL_ISR(131);
	INSTALL_ISR(132);
	INSTALL_ISR(133);
	INSTALL_ISR(134);
	INSTALL_ISR(135);
	INSTALL_ISR(136);
	INSTALL_ISR(137);
	INSTALL_ISR(138);
	INSTALL_ISR(139);
	INSTALL_ISR(140);
	INSTALL_ISR(141);
	INSTALL_ISR(142);
	INSTALL_ISR(143);
	INSTALL_ISR(144);
	INSTALL_ISR(145);
	INSTALL_ISR(146);
	INSTALL_ISR(147);
	INSTALL_ISR(148);
	INSTALL_ISR(149);
	INSTALL_ISR(150);
	INSTALL_ISR(151);
	INSTALL_ISR(152);
	INSTALL_ISR(153);
	INSTALL_ISR(154);
	INSTALL_ISR(155);
	INSTALL_ISR(156);
	INSTALL_ISR(157);
	INSTALL_ISR(158);
	INSTALL_ISR(159);
	INSTALL_ISR(160);
	INSTALL_ISR(161);
	INSTALL_ISR(162);
	INSTALL_ISR(163);
	INSTALL_ISR(164);
	INSTALL_ISR(165);
	INSTALL_ISR(166);
	INSTALL_ISR(167);
	INSTALL_ISR(168);
	INSTALL_ISR(169);
	INSTALL_ISR(170);
	INSTALL_ISR(171);
	INSTALL_ISR(172);
	INSTALL_ISR(173);
	INSTALL_ISR(174);
	INSTALL_ISR(175);
	INSTALL_ISR(176);
	INSTALL_ISR(177);
	INSTALL_ISR(178);
	INSTALL_ISR(179);
	INSTALL_ISR(180);
	INSTALL_ISR(181);
	INSTALL_ISR(182);
	INSTALL_ISR(183);
	INSTALL_ISR(184);
	INSTALL_ISR(185);
	INSTALL_ISR(186);
	INSTALL_ISR(187);
	INSTALL_ISR(188);
	INSTALL_ISR(189);
	INSTALL_ISR(190);
	INSTALL_ISR(191);
	INSTALL_ISR(192);
	INSTALL_ISR(193);
	INSTALL_ISR(194);
	INSTALL_ISR(195);
	INSTALL_ISR(196);
	INSTALL_ISR(197);
	INSTALL_ISR(198);
	INSTALL_ISR(199);
	INSTALL_ISR(200);
	INSTALL_ISR(201);
	INSTALL_ISR(202);
	INSTALL_ISR(203);
	INSTALL_ISR(204);
	INSTALL_ISR(205);
	INSTALL_ISR(206);
	INSTALL_ISR(207);
	INSTALL_ISR(208);
	INSTALL_ISR(209);
	INSTALL_ISR(210);
	INSTALL_ISR(211);
	INSTALL_ISR(212);
	INSTALL_ISR(213);
	INSTALL_ISR(214);
	INSTALL_ISR(215);
	INSTALL_ISR(216);
	INSTALL_ISR(217);
	INSTALL_ISR(218);
	INSTALL_ISR(219);
	INSTALL_ISR(220);
	INSTALL_ISR(221);
	INSTALL_ISR(222);
	INSTALL_ISR(223);
	INSTALL_ISR(224);
	INSTALL_ISR(225);
	INSTALL_ISR(226);
	INSTALL_ISR(227);
	INSTALL_ISR(228);
	INSTALL_ISR(229);
	INSTALL_ISR(230);
	INSTALL_ISR(231);
	INSTALL_ISR(232);
	INSTALL_ISR(233);
	INSTALL_ISR(234);
	INSTALL_ISR(235);
	INSTALL_ISR(236);
	INSTALL_ISR(237);
	INSTALL_ISR(238);
	INSTALL_ISR(239);
	INSTALL_ISR(240);
	INSTALL_ISR(241);
	INSTALL_ISR(242);
	INSTALL_ISR(243);
	INSTALL_ISR(244);
	INSTALL_ISR(245);
	INSTALL_ISR(246);
	INSTALL_ISR(247);
	INSTALL_ISR(248);
	INSTALL_ISR(249);
	INSTALL_ISR(250);
	INSTALL_ISR(251);
	INSTALL_ISR(252);
	INSTALL_ISR(253);
	INSTALL_ISR(254);
	INSTALL_ISR(255);

	irq_install();
	idt_load((uintptr_t)idt_p);
}
